pipeline {
    agent any

    environment {
        SONAR_QUBE_ENV  = 'SonarQube'
        REGISTRY        = 'localhost:32000'
        IMAGE_NAME      = 'portal-be'
        IMAGE_TAG       = "${env.GIT_COMMIT?.take(8) ?: 'latest'}"
        STAGING_NS      = 'apps-staging'
        PROD_NS         = 'apps-prod'
        JIRA_SITE       = 'jira.platform.svc.cluster.local'
        JIRA_PROJECT    = 'DEVOPS'
    }

    parameters {
        string(name: 'ISSUE_KEY', defaultValue: '', description: 'Jira Issue Key (e.g. DEVOPS-1)')
        string(name: 'BRANCH', defaultValue: 'main', description: 'Branch to build')
    }

    tools {
        maven 'Maven-3.9'
    }

    stages {

        // ───── Stage 1: Clone ─────
        stage('Clone') {
            steps {
                checkout scm
            }
        }

        // ───── Stage 2: Unit Test ─────
        stage('Unit Test') {
            steps {
                dir('portal-be') {
                    sh 'mvn test -B'
                }
            }
            post {
                always {
                    junit testResults: 'portal-be/target/surefire-reports/*.xml', allowEmptyResults: true
                }
                failure {
                    script { notifyJira('Unit Tests FAILED') }
                }
            }
        }

        // ───── Stage 3: Code Quality ─────
        stage('Code Quality') {
            steps {
                dir('portal-be') {
                    withSonarQubeEnv(env.SONAR_QUBE_ENV) {
                        sh '''
                            mvn sonar:sonar \
                                -Dsonar.projectKey=portal-be \
                                -Dsonar.projectName="Portal Backend" \
                                -Dsonar.java.binaries=target/classes \
                                -Dsonar.coverage.jacoco.xmlReportPaths=target/site/jacoco/jacoco.xml \
                                -B
                        '''
                    }
                }
                script {
                    try {
                        timeout(time: 2, unit: 'MINUTES') {
                            waitForQualityGate abortPipeline: false
                        }
                    } catch (Exception e) {
                        echo "Quality gate check timed out or failed: ${e.message}"
                    }
                }
            }
            post {
                failure {
                    script { notifyJira('Quality Gate FAILED') }
                }
            }
        }

        // ───── Stage 4: Security Check (SAST) ─────
        stage('Security Check') {
            steps {
                dir('portal-be') {
                    sh 'mvn spotbugs:check -B || true'
                }
            }
        }

        // ───── Stage 5: Build ─────
        stage('Build') {
            steps {
                dir('portal-be') {
                    sh 'mvn package -DskipTests -B'
                    archiveArtifacts artifacts: 'target/*.jar', fingerprint: true
                }
            }
        }

        // ───── Stage 6: Test (Integration / API) ─────
        stage('Test') {
            steps {
                echo 'Integration tests placeholder - requires staging deployment'
            }
        }

        // ───── Stage 7: Release Approval (Jira-driven) ─────
        stage('Release Approval') {
            steps {
                script {
                    try {
                        def issueKey = params.ISSUE_KEY
                        if (!issueKey) {
                            issueKey = createJiraIssue("Release approval for portal-be build #${env.BUILD_NUMBER}")
                        }

                        echo "Waiting for Jira approval on ${issueKey}..."

                        timeout(time: 60, unit: 'MINUTES') {
                            waitUntil(initialRecurrencePeriod: 15000) {
                                def approved = checkJiraApproval(issueKey)
                                return approved
                            }
                        }
                    } catch (Exception e) {
                        echo "Release approval skipped: ${e.message}"
                    }
                }
            }
        }

        // ───── Stage 8: Penetration Test ─────
        stage('Penetration Test') {
            steps {
                echo 'Penetration test placeholder - requires Docker and staging environment'
            }
        }

        // ───── Stage 9: Deploy ─────
        stage('Deploy') {
            steps {
                echo 'Production deployment placeholder - requires kubectl access'
                script {
                    notifyJira("portal-be build #${env.BUILD_NUMBER} completed successfully")
                }
            }
        }
    }

    post {
        success {
            echo 'Pipeline completed successfully!'
            script { notifyJira('Pipeline SUCCEEDED') }
        }
        failure {
            echo 'Pipeline failed. Check logs above.'
            script { notifyJira('Pipeline FAILED') }
        }
    }
}

// ───── Helper Functions ─────

def notifyJira(String message) {
    def issueKey = params.ISSUE_KEY
    if (!issueKey) return
    try {
        withCredentials([string(credentialsId: 'jira-pat', variable: 'JIRA_TOKEN')]) {
            sh """
                curl -s \
                    -H "Authorization: Bearer \${JIRA_TOKEN}" \
                    -X POST \
                    -H "Content-Type: application/json" \
                    -d '{"body": "[Jenkins] ${message} - Build #${env.BUILD_NUMBER}"}' \
                    "http://${JIRA_SITE}/rest/api/2/issue/${issueKey}/comment"
            """
        }
    } catch (Exception e) {
        echo "Jira notification failed: ${e.message}"
    }
}

def checkJiraApproval(String issueKey) {
    def result = false
    try {
        withCredentials([string(credentialsId: 'jira-pat', variable: 'JIRA_TOKEN')]) {
            def response = sh(script: """
                curl -s \
                    -H "Authorization: Bearer \${JIRA_TOKEN}" \
                    "http://${JIRA_SITE}/rest/api/2/issue/${issueKey}"
            """, returnStdout: true).trim()
            def issue = new groovy.json.JsonSlurper().parseText(response)
            def status = issue.fields?.status?.name?.toLowerCase()
            def labels = issue.fields?.labels?.collect { it.toLowerCase() }
            result = (status == 'approved' || labels?.contains('approved'))
        }
    } catch (Exception e) {
        echo "Jira check failed: ${e.message}"
    }
    return result
}

def createJiraIssue(String summary) {
    def issueKey = ''
    try {
        withCredentials([string(credentialsId: 'jira-pat', variable: 'JIRA_TOKEN')]) {
            def response = sh(script: """
                curl -s \
                    -H "Authorization: Bearer \${JIRA_TOKEN}" \
                    -X POST \
                    -H "Content-Type: application/json" \
                    -d '{"fields": {"project": {"key": "${JIRA_PROJECT}"}, "summary": "${summary}", "issuetype": {"name": "Task"}}}' \
                    "http://${JIRA_SITE}/rest/api/2/issue"
            """, returnStdout: true).trim()
            def json = new groovy.json.JsonSlurper().parseText(response)
            issueKey = json.key
        }
    } catch (Exception e) {
        error("Failed to create Jira issue: ${e.message}")
    }
    return issueKey
}
